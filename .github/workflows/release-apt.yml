name: Release APT repository

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

permissions:
  contents: write
  id-token: write

jobs:
  make-draft-release:
    name: make draft release
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create draft release
        run: |
          gh release create ${GITHUB_REF_NAME} \
            --draft \
            --title ${GITHUB_REF_NAME} \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-debs:
    name: Build Debian packages
    needs: make-draft-release
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          tags: true

      - name: Install build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y devscripts debhelper fakeroot build-essential lintian dkms

      - name: Set Debian changelog version from tag (handle prereleases)
        run: |
          # GITHUB_REF_NAME examples: v1.2.3 or v1.2.3-beta1
          raw=${GITHUB_REF_NAME#v}
          # Convert prerelease hyphen to Debian-friendly ~ (only first hyphen)
          if echo "$raw" | grep -q "-"; then
            upver=$(echo "$raw" | sed 's/-/~/')
            echo "Detected prerelease tag. Upstream version will be: $upver"
          else
            upver=$raw
          fi
          echo "Setting Debian changelog version to ${upver}-1"
          dch --force-bad-version -v ${upver}-1 "Release ${GITHUB_REF_NAME}"
          cat debian/changelog
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Patch debian packaging files to use new version
        run: |
          raw=${GITHUB_REF_NAME#v}
          if echo "$raw" | grep -q "-"; then
            # convert first '-' to '~' for Debian prerelease ordering for upstream version
            upver=$(echo "$raw" | sed 's/-/~/')
            # For paths and filenames (no ~ allowed), use raw version without 'v'
            pathver=$raw
          else
            upver=$raw
            pathver=$raw
          fi
          echo "Patching debian files to upver=${upver}, pathver=${pathver}"
          # update dkms control & install paths (dkms uses plain numeric path names)
          sed -i "s/snd-zg01 1.0.0/snd-zg01 ${pathver}/g" debian/snd-zg01-dkms.dkms || true
          sed -i "s/usr\/src\/snd-zg01-1.0.0/usr\/src\/snd-zg01-${pathver}/g" debian/snd-zg01-dkms.install || true
          # update postinst/postrm VERSION definitions (these are for runtime, use path version)
          sed -i "s/VERSION=1.0.0/VERSION=${pathver}/g" debian/snd-zg01-dkms.postinst || true
          sed -i "s/VERSION=1.0.0/VERSION=${pathver}/g" debian/snd-zg01-dkms.postrm || true
          # show results
          echo "--- dkms file ---"
          cat debian/snd-zg01-dkms.dkms || true
          echo "--- install file ---"
          cat debian/snd-zg01-dkms.install || true
          echo "--- postinst ---"
          sed -n '1,120p' debian/snd-zg01-dkms.postinst || true
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Build package
        run: |
          # assume packaging metadata is present under debian/ and top-level Makefile
          dpkg-buildpackage -us -uc -b

      - name: Run lintian
        if: success()
        run: |
          lintian --display-info --pedantic ../*.changes || true

      - name: Upload debs to release
        run: |
          gh release upload ${GITHUB_REF_NAME} ../*.deb --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-apt-repo:
    name: Release APT repository
    needs: [make-draft-release, build-debs]
    runs-on: ubuntu-24.04
    environment: apt-signing
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: GPG configuration
        run: |
          mkdir -p -m 0700 $HOME/.gnupg
          echo "use-agent" > $HOME/.gnupg/gpg.conf
          echo "pinentry-program $GITHUB_WORKSPACE/.github/scripts/pinentry.sh" > $HOME/.gnupg/gpg-agent.conf
          echo "$GPG_PASSPHRASE" > $HOME/.gnupg/passphrase
          gpgconf --launch gpg-agent
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "$GPG_KEY_ID:6:" | gpg --import-ownertrust
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Download debs from release
        run: |
          mkdir -p tmp
          gh release download ${GITHUB_REF_NAME} -p "*.deb" -D tmp
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate APT repository files
        run: |
          pushd tmp
          apt-ftparchive packages . | tee Packages | xz > Packages.xz
          apt-ftparchive release -c ../debian/release.conf . > Release || apt-ftparchive release . > Release
          gpg --batch --yes --pinentry-mode loopback --passphrase-file $HOME/.gnupg/passphrase --clearsign -o InRelease Release
          gpg --batch --yes --pinentry-mode loopback --passphrase-file $HOME/.gnupg/passphrase --armor --detach-sign --sign -o Release.gpg Release
          gh release upload ${GITHUB_REF_NAME} InRelease Packages Packages.xz Release Release.gpg --clobber
          popd
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
